@using MirGames.Domain.Wip.ViewModels
@model WipProjectViewModel
@{
    ViewBag.Title = "Баг-трекер / " + Model.Title;
    AddPageCssClass("wip-workitems-page");
    PageScriptController = "MirGames.Wip.ProjectWorkItemsPage";
}

@section Nav
{
    @Html.Partial("_ProjectMenu", Model)
}
    
@Html.Partial("_ProjectInfo", Model)

<section>
    <h4>Баг-трекер</h4>
    <form ng-cloak class="toolbar">
        <div class="form-field">
            <a ng-class="{ 'button': 1, 'selected': viewMode == 0 }" href="javascript:void(0)" ng-click="showList()"><i class="fa fa-list"></i></a>
        </div>
        <div class="form-field">
            <a ng-class="{ 'button': 1, 'selected': viewMode == 1 }" href="javascript:void(0)" ng-click="showBlocks()"><i class="fa fa-th-large"></i></a>
        </div>
        <div class="form-field dropdown">
            <a class="dropdown-toggle">
                <i class="fa fa-caret-down"></i>{{typeNames[filterByType] || 'Все типы'}}
            </a>
            <ul class="dropdown-menu">
                <li>
                    <a ng-click="setFilterByType(null)">Все типы</a>
                </li>
                <li>
                    <a ng-click="setFilterByType(1)"><i class="fa fa-bug"></i>{{typeNames[1]}}</a>
                </li>
                <li>
                    <a ng-click="setFilterByType(2)"><i class="fa fa-check-square-o"></i>{{typeNames[2]}}</a>
                </li>
                <li>
                    <a ng-click="setFilterByType(3)"><i class="fa fa-plus-square"></i>{{typeNames[3]}}</a>
                </li>
            </ul>
        </div>
        <div class="form-field dropdown">
            <a class="dropdown-toggle">
                <i class="fa fa-caret-down"></i>{{statusNames[filterByStatus] || 'В любом статусе'}}
            </a>
            <ul class="dropdown-menu">
                <li>
                    <a ng-click="setFilterByStatus(null)">В любом статусе</a>
                </li>
                <li>
                    <a ng-click="setFilterByStatus(4)">{{statusNames[4]}}</a>
                </li>
                <li>
                    <a ng-click="setFilterByStatus(1)">{{statusNames[1]}}</a>
                </li>
                <li>
                    <a ng-click="setFilterByStatus(3)">{{statusNames[3]}}</a>
                </li>
                <li>
                    <a ng-click="setFilterByStatus(2)">{{statusNames[2]}}</a>
                </li>
                <li>
                    <a ng-click="setFilterByStatus(5)">{{statusNames[5]}}</a>
                </li>
            </ul>
        </div>
    </form>
    <div class="tracker-items" ng-if="viewMode == 0">
        <div ng-class="['tracker-item', item.type, item.state, 'p' + item.priority, $last ? 'last' : '']" ng-repeat="item in items" ng-cloak>
            <div ng-class="['item-status', item.canBeEdited ? 'change-status' : '' ]" ng-click="item.changeState()">
                <span class="open-status" title="Доступно"><i class="fa fa-circle-o"></i></span>
                <span class="active-status" title="В процессе"><i class="fa fa-cogs"></i></span>
                <span class="closed-status" title="Завершено"><i class="fa fa-check-circle"></i></span>
            </div>
            <div class="item-type">
                <span class="bug-type" title="Баг" ng-show="item.type == 'Bug'"><i class="fa fa-bug"></i></span>
                <span class="task-type" title="Задача" ng-show="item.type == 'Task'"><i class="fa fa-check-square-o"></i></span>
                <span class="feature-type" title="Фича" ng-show="item.type == 'Feature'"><i class="fa fa-plus-square"></i></span>
            </div>
            <div class="title">
                <a href="{{item.url}}">
                    {{item.title}}
                </a>
                <div class="description">{{item.description}}</div>
            </div>
            <ul class="tags">
                <li ng-repeat="tag in item.tags"><a href="{{tag.url}}">{{tag.text}}</a></li>
            </ul>
            <div class="internal-id">
                #{{item.internalId}}
            </div>
            <div class="author">
                <a author-link="item.author.id" class="avatar-link" title="Добавил {{item.author.login}}">
                    <img ng-src="{{item.author.avatar}}" class="avatar avatar-tiny" />
                </a>
            </div>
        </div>
        <div ng-show="!items.length" ng-cloak>
            В проекте пока нет ни задач, ни багов.
        </div>
        <div class="data-loading" ng-hide="dataLoaded"></div>
    </div>
    
    <script type="text/ng-template" id="/item-block-template.html">
        <div class="item-type">
            <span class="bug-type" title="Баг" ng-show="item.type == 'Bug'"><i class="fa fa-bug"></i></span>
            <span class="task-type" title="Задача" ng-show="item.type == 'Task'"><i class="fa fa-check-square-o"></i></span>
            <span class="feature-type" title="Фича" ng-show="item.type == 'Feature'"><i class="fa fa-plus-square"></i></span>
        </div>
        <div class="title">
            <a href="{{item.url}}">
                {{item.title}}
            </a>
            <div class="description">{{item.description}}</div>
        </div>
        <ul class="tags">
            <li ng-repeat="tag in item.tags"><a href="{{tag.url}}">{{tag.text}}</a></li>
        </ul>
        <div class="internal-id">
            #{{item.internalId}}
        </div>
        <div class="author">
            <a author-link="item.author.id" class="avatar-link" title="Добавил {{item.author.login}}">
                <img ng-src="{{item.author.avatar}}" class="avatar avatar-tiny" />
            </a>
        </div>
    </script>
    <div class="tracker-item-blocks" ng-if="viewMode == 1">
        <div class="open-items items">
            <h1>Открытые</h1>
            <div ng-class="['tracker-item', item.type, item.state, 'p' + item.priority, $last ? 'last' : '']" ng-repeat="item in items | filter: { state: 'Open' }" ng-cloak static-include="/item-block-template.html">
            </div>
        </div>
        <div class="active-items items">
            <h1>Активные</h1>
            <div ng-class="['tracker-item', item.type, item.state, 'p' + item.priority, $last ? 'last' : '']" ng-repeat="item in items | filter: { state: 'Active' }" ng-cloak static-include="/item-block-template.html">
            </div>
        </div>
        <div class="closed-items items">
            <h1>Закрытые</h1>
            <div ng-class="['tracker-item', item.type, item.state, 'p' + item.priority, $last ? 'last' : '']" ng-repeat="item in items | filter: { state: 'Closed' }" ng-cloak static-include="/item-block-template.html">
            </div>
        </div>
        <div class="data-loading" ng-hide="dataLoaded"></div>
    </div>
    @if (Model.CanCreateBug || Model.CanCreateFeature || Model.CanCreateTask)
    {
        <h4 ng-cloak>
            Новая {{typeNames[newItem.type]}}
        </h4>
        <form class="new-item-form" name="newItemForm" ng-cloak>
            <div class="form-field" ng-show="newItem.availableItemTypes.length > 1">
                <label>Тип элемента</label>
                <div class="radio-group">
                    <button type="button" class="radio" ng-model="newItem.type" ng-show="newItem.availableItemTypes.indexOf(1) + 1" btn-radio="1" ng-click="newItem.focus=true"><i class="fa fa-bug"></i>{{typeNames[1]}}</button>
                    <button type="button" class="radio" ng-model="newItem.type" ng-show="newItem.availableItemTypes.indexOf(2) + 1" btn-radio="2" ng-click="newItem.focus=true"><i class="fa fa-check-square-o"></i>{{typeNames[2]}}</button>
                    <button type="button" class="radio" ng-model="newItem.type" ng-show="newItem.availableItemTypes.indexOf(3) + 1" btn-radio="3" ng-click="newItem.focus=true"><i class="fa fa-plus-square"></i>{{typeNames[3]}}</button>
                </div>
            </div>
            <div class="form-field">
                <label>Заголовок</label>
                <input type="text" ng-model="newItem.title" ng-focused="newItem.focus" required="required" maxlength="256" />
            </div>
            <div class="form-field">
                <label>Тэги <i>(опционально)</i></label>
                <input type="text" ng-model="newItem.tags" pattern="([^,]+,?){0,5}" />
            </div>
            <div class="form-field">
                <label>Описание</label>
                <texteditor text="newItem.text" show-preview="true" post="newItem.post()" focus="false" attachments="newItem.attachments" entity-type="project-work-item"></texteditor>
            </div>
            <div class="buttons">
                <a href="javascript:void(0);" ng-click="newItem.post()" ng-class="{ 'button-disabled': newItemForm.$invalid }" class="button">Отправить</a>
            </div>
        </form>
    }
</section>