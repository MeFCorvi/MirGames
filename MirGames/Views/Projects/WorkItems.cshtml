@using MirGames.Domain.Security
@using MirGames.Domain.Wip.ViewModels
@model WipProjectViewModel
@{
    ViewBag.Title = "Баг-трекер / " + Model.Title;
    AddPageCssClass("wip-workitems-page");
    PageScriptController = "MirGames.Wip.ProjectWorkItemsPage";
}

@section Nav
{
    @Html.Partial("_ProjectMenu", Model)
}
    
@Html.Partial("_ProjectInfo", Model)

<section>
    <h4>Баг-трекер</h4>
    <div class="tracker-items">
        <div ng-class="['tracker-item', item.type, item.state]" ng-repeat="item in items" ng-cloak>
            <div class="item-type">
                <span class="bug-type" title="Баг" ng-show="item.type == 'Bug'"><i class="fa fa-bug"></i></span>
                <span class="task-type" title="Задача" ng-show="item.type == 'Task'"><i class="fa fa-check-square-o"></i></span>
                <span class="feature-type" title="Фича" ng-show="item.type == 'Feature'"><i class="fa fa-plus-square"></i></span>
            </div>
            <div class="title">
                <a href="{{item.url}}">
                    {{item.title}}
                </a>
            </div>
            <ul class="tags">
                <li ng-repeat="tag in item.tags"><a href="{{tag.url}}">{{tag.text}}</a></li>
            </ul>
            <div class="internal-id">
                #{{item.internalId}}
            </div>
            <div class="author">
                <a author-link="item.author.id" class="avatar-link" title="Добавил {{item.author.login}}">
                    <img ng-src="{{item.author.avatar}}" class="avatar avatar-tiny" />
                </a>
            </div>
        </div>
        <div ng-show="!items.length" ng-cloak>
            В проекте пока нет ни задач, ни багов.
        </div>
        <div class="data-loading" ng-hide="dataLoaded"></div>
    </div>
    @if (Model.CanCreateBug || Model.CanCreateFeature || Model.CanCreateTask)
    {
        <h4 ng-cloak>
            Новая {{typeNames[newItem.type]}}
        </h4>
        <form class="new-item-form" name="newItemForm" ng-cloak>
            <div class="form-field" ng-show="newItem.availableItemTypes.length > 1">
                <label>Тип элемента</label>
                <div class="radio-group">
                    <button type="button" class="radio" ng-model="newItem.type" ng-show="newItem.availableItemTypes.indexOf(1) + 1" btn-radio="1" ng-click="newItem.focus=true"><i class="fa fa-bug"></i>{{typeNames[1]}}</button>
                    <button type="button" class="radio" ng-model="newItem.type" ng-show="newItem.availableItemTypes.indexOf(2) + 1" btn-radio="2" ng-click="newItem.focus=true"><i class="fa fa-check-square-o"></i>{{typeNames[2]}}</button>
                    <button type="button" class="radio" ng-model="newItem.type" ng-show="newItem.availableItemTypes.indexOf(3) + 1" btn-radio="3" ng-click="newItem.focus=true"><i class="fa fa-plus-square"></i>{{typeNames[3]}}</button>
                </div>
            </div>
            <div class="form-field">
                <label>Заголовок</label>
                <input type="text" ng-model="newItem.title" ng-focused="newItem.focus" required="required" maxlength="256" />
            </div>
            <div class="form-field">
                <label>Тэги <i>(опционально)</i></label>
                <input type="text" ng-model="newItem.tags" pattern="([^,]+,?){0,5}" />
            </div>
            <div class="form-field">
                <label>Описание</label>
                <texteditor text="newItem.text" show-preview="true" post="newItem.post()" focus="false" attachments="newItem.attachments" entity-type="project-work-item"></texteditor>
            </div>
            <div class="buttons">
                <a href="javascript:void(0);" ng-click="newItem.post()" ng-class="{ 'button-disabled': newItemForm.$invalid }" class="button">Отправить</a>
            </div>
        </form>
    }
</section>